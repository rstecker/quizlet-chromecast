<!DOCTYPE html>
<html>
<head>
  <title>Quizlet AWESOME</title>
  <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
  <script src="https://www.gstatic.com/cast/sdk/libs/receiver/2.0.0/cast_receiver.js"></script>
  <script src="lib/knockout.min.js"></script>
<style>
.logs{
  font-family: monospace;
  margin-left: 25px;
  font-size: 12px;
}
</style>
</head>
<body bgcolor=red>
<div id="content">
Set Id: <span data-bind="text: setId"></span><br>
<div data-bind="visible: set.loaded">
  Name: <span data-bind="text: set.name"></span><br> [<span data-bind="text: set.id"></span>]
  by: <span data-bind="text: set.creator"></span>
</div>
  <div style="border: 1px solid green;" data-bind="foreach: players">
    <span data-bind="text: name"></span><sub>[<span data-bind="text: senderId"></sub>] : <span data-bind="text: score"></span>
  </div>
</div>
HELLO WORLD & QUIZLET!
<br>
Send the receiver a msg of type GET_PROTOCALL to get a list of current valid actions
<div class="logs">
</div>
<template id="protocall">
Current protocall:
  LOAD_SET : expects an id
  SET_USERNAME : expects a string
  GET_PROTOCALL : expects nothing, returns this text as 'msg'
</template>
<script>
var gameState = {
  players: {},
  state: 'WAITNG',
  set: null,
};
var vm = {
  setId: ko.observable('TBD'),
  set: {
    loaded: ko.observable(false),
    id: ko.observable('TBD'),
    name: ko.observable('TBD'),
    creator: ko.observable('TBD'),
  },
  players: ko.observableArray([]),
  senderIdToPlayerIndex: {},
  playerBySenderId: function(senderId) {
    return this.players()[this.senderIdToPlayerIndex[senderId]];
  }
}
ko.applyBindings(vm, document.getElementById('content'))
function addNewPlayerUI(senderId) {
  vm.senderIdToPlayerIndex[senderId] = vm.players().length;
  vm.players.push({
    name: ko.observable('TBD'),
    senderId: ko.observable(senderId),  // this will never change so it doesn't really need to be an observable...
    score: ko.observable(0),
  })
}
function loadSetUi(setObj) {
  vm.set.loaded(true);
  vm.set.id(setObj.id);
  vm.set.name(setObj.title);
  vm.set.creator(setObj.created_by);
}
var quizletClientId = 'BcpDSe7sYr';
var appConfig = new cast.receiver.CastReceiverManager.Config();
appConfig.maxInactivity = 10000;
appConfig.statusText = "Quizlet Hack Day";
var manager = cast.receiver.CastReceiverManager.getInstance();
var messageBus = manager.getCastMessageBus('urn:x-cast:duck', cast.receiver.CastMessageBus.MessageType.JSON);

function displayAction(msg) {
  $('.logs').prepend('<div>'+msg+'</div>');
}

function loadSetData(setId){
  vm.setId(setId);
  var url = '/proxy/https://api.quizlet.com/2.0/sets/'+setId+'?client_id='+quizletClientId;
  $.get(url).done(function(x) {
    displayAction( " success" );
    console.log("success w/ ",x);
    gameState.set = x;
    loadSetUi(x);
    broadcastState('set loaded');
  })
  .fail(function() {
    displayAction( "error" );
  })
  .always(function() {
    displayAction( "finished" );
  });
}

messageBus.onMessage = function(event) {
  console.log("WHAT IS THIS? ",event);
  var message = event.data;
  var senderId = event.senderId;
  if (message.type == 'LOAD_SET') {
    var setId = message.data;
    displayAction("User '"+senderId+"' is trying to load set "+setId);
    loadSetData(setId);
  }else if (message.type == 'SET_USERNAME') {
    var username = message.data;
    // TODO : protect against bad username data somehow?
    displayAction("User '"+senderId+"' is trying to set username to "+username);
    gameState.players[senderId].username = username;
    vm.playerBySenderId(senderId).name(username);
    broadcastState('Updated username for '+senderId);
  }else if (message.type == 'GET_PROTOCALL') {
    messageBus.send(senderId, {'msg': $('#protocall').html()});
  }
   else {
    displayAction("What you say?? : "+message.type+" :: "+message.data);
  }
};

manager.onSenderConnected = function(evt) {
  var senderId = evt.data;
  addNewPlayerUI(senderId)
  gameState.players[senderId] = {state: 'connected'};
  displayAction("connected w/ "+ senderId);
  document.body.style.backgroundColor = 'black';
  document.body.style.color = 'white';
  broadcastState('new player : '+senderId);
};

function broadcastState(reason) {
  Object.keys(gameState.players).forEach(function(senderId) {
    messageBus.send(senderId, {
      reason: reason,
      gameState: gameState,
    });
  });
}
manager.start(appConfig);
</script>
</body>
</html>
